function tick(){node.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})}function dblclick(t){d3.select(this).classed("fixed",t.fixed=!1)}function dragstart(t){d3.select(this).classed("fixed",t.fixed=!0),svg.selectAll(".grey-back").transition().style("opacity",.3)}function dragend(){svg.selectAll(".grey-back").transition().style("opacity",0),d3.select(this).classed("fixed",function(t){var e=d3.selectAll(".claim"),a=(d3.selectAll(".title"),!1);if(t.p.forEach(function(e,r){var n=Math.sqrt(Math.abs(t.x-e.x)*Math.abs(t.x-e.x)+Math.abs(t.y-e.y)*Math.abs(t.y-e.y));n<=atraction_bg&&Array.isArray(rect_array)&&(t.px=e.x,t.py=e.y,a=!0)}),a){var r=rect_array.indexOf(t.n);if(r<0){switch(rect_array.push(t.n),rect_array.length){case 1:e.text("Bien, bien, ese es el camino");break;case 2:e.text("Uno menos!");break;case 3:e.text("Olé");break;case 4:e.text("Vamos, no pares!");break;case 5:e.text("No pienses, actúa!");break;case 6:e.text("Ya casi lo tienes!");break;case 7:e.text("Un poco más!");break;case 8:e.text("Vamosss!!!");break;case 9:e.text("Where is your god now?"),update()}svg.select(".title").text(function(){return parseInt(svg.select(".title").text())+1})}else e.text("¿Qué estás intentando?");return t.fixed=!0,!0}return svg.selectAll(".node").classed("fixed",function(t){t.fixed=!1}),svg.selectAll(".level").transition().style("opacity",1),rect_array=[],svg.select(".title").text("0"),parseInt(svg.select(".level--value").text())<=0?e.text("¿¡Pero qué has hecho!?"):e.text("Eso no iba ahi!"),!1})}var margin={top:50,right:20,bottom:50,left:20},width=parseInt(d3.select("#chart").style("width"),10),width=width-margin.left-margin.right,height=parseInt(d3.select("html").style("height"),10),height=height-margin.top-margin.bottom,rect_width=width>=600?100:width/5,separation=.28*rect_width,atraction_bg=rect_width/2,title_size=width>=600?"10.1rem":width/5+"px",claim_size=width>=600?"2rem":width/15+"px",rect_array=0,color_array=[],force=d3.layout.force().size([width,height]).charge(-400).linkDistance(3*rect_width).on("tick",tick),drag=force.drag().on("dragstart",dragstart).on("dragend",dragend),svg=d3.select("#chart").append("svg").attr("width",width+margin.left+margin.right-12).attr("height",height+margin.top+margin.bottom-12),g=svg.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),node=g.append("g").attr("class","nodes-group").selectAll(".node"),update=function(){};d3.json("../wp-content/themes/aedisevilla-5scd/assets/data/graph3.json",function(t,e){if(t)throw t;var a=d3.max(e.nodes,function(t){return t.x}),r=(d3.max(e.nodes,function(t){return t.y}),rect_width*a+separation*(a-1));e.nodes.forEach(function(t,a){t.p=[],e.nodes.forEach(function(e,a){if(t.fill==e.fill){var r={};r.x=+e.x,r.y=+e.y,t.p.push(r)}});var r=color_array.indexOf(t.fill);r<0&&color_array.push(t.fill)}),colorScale=chroma.scale(color_array).domain([0,color_array.length-1]),e.nodes.forEach(function(t,e){t.x=(+t.x-1)*rect_width+(+t.x-1)*separation+(width-r+rect_width)/2,t.y=(+t.y-1)*rect_width+(+t.y-1)*separation+(height-r)/2,t.p.forEach(function(t,e){t.x=+((+t.x-1)*rect_width+(+t.x-1)*separation+(width-r+rect_width)/2),t.y=+((+t.y-1)*rect_width+(+t.y-1)*separation+(height-r)/2)})}),force.nodes(e.nodes).links(e.links).start();var n=g.append("g").attr("class","grey-group").style("pointer-events","none");n.selectAll("rect").data(function(){return e.nodes}).enter().append("rect").attr("class","grey-back").attr("x",function(t){return t.x-rect_width/2}).attr("y",function(t){return t.y-rect_width/2}).attr("width",rect_width).attr("height",rect_width).style("fill","transparent").style("stroke","#000").style("stroke-width","1px").style("opacity",0),node=node.data(e.nodes).enter().append("g").attr("class","node").classed("fixed",function(t){t.fixed=!0}).on("dblclick",dblclick).call(drag);var i=node.append("g").attr("transform","translate("+-rect_width/2+","+-rect_width/2+")"),s=i.append("rect").attr("width",rect_width).attr("height",rect_width).style("fill",function(t){return t.fill}),l=i.append("polygon").attr("points","0,0 0,"+rect_width+" "+rect_width+",0").style("opacity",.1).style("fill","#000"),c=g.append("g").attr("transform","translate("+width/2+","+((r+height)/2+72)+")");c.append("text").attr("class","title").attr("text-anchor","middle").style("font-size",title_size).text("#5SCD"),c.append("text").attr("class","claim").attr("transform","translate(0,48)").attr("text-anchor","middle").style("font-size",claim_size).text("Let's touch"),c.append("text").attr("class","level level--label").attr("text-anchor","start").attr("transform","translate("+(20+r/2)+",0)").style("font-size",claim_size).style("opacity","0").text("Lvl"),c.append("text").attr("class","level level--value").attr("text-anchor","start").attr("transform","translate("+(70+r/2)+",0)").style("font-size",claim_size).style("opacity","0").text("0"),update=function(){for(var t=1;t<5;t++)new_node={x:4,y:+t,p:[],fill:colorScale(Math.floor(Math.random()*color_array.length)),n:e.nodes.length},new_node.x=(+new_node.x-1)*rect_width+(+new_node.x-1)*separation+(width-r+rect_width)/2+margin.left,new_node.y=(+new_node.y-1)*rect_width+(+new_node.y-1)*separation+(height-r)/2+margin.top,new_node.p.forEach(function(t,e){t.x=t.x+margin.left,t.y=t.y+margin.top}),e.nodes.push(new_node);node=svg.selectAll(".node").data(force.nodes()),node_enter=node.enter().append("g").attr("class","node").classed("fixed",function(t){t.fixed=!1}).on("dblclick",dblclick).call(drag),i=node_enter.append("g").attr("transform","translate("+-rect_width/2+","+-rect_width/2+")"),s=i.append("rect").attr("width",rect_width).attr("height",rect_width).style("fill",function(t){return t.fill}),l=i.append("polygon").attr("points","0,0 0,"+rect_width+" "+rect_width+",0").style("opacity",.1).style("fill","#000"),svg.selectAll(".node").classed("fixed",function(t){t.fixed=!1}),svg.select(".level--value").text(function(){return parseInt(svg.select(".level--value").text())+1}),svg.select(".title").text("0"),rect_array=[],force.start()}});